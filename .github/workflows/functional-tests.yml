name: Functional Tests (Real DB)

on:
  push:
    branches: [master]
  pull_request:
    branches: [master, dev]

jobs:
  functional-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - db: mysql
            db_image: mysql:8.0
            db_port: 3306
            db_user: root
            db_password: root
            db_driver: pdo_mysql
            server_version: '8.0'
          - db: postgres
            db_image: postgres:15
            db_port: 5432
            db_user: postgres
            db_password: postgres
            db_driver: pdo_pgsql
            server_version: '15'

    name: Functional (${{ matrix.db }})

    services:
      database:
        image: ${{ matrix.db_image }}
        env:
          MYSQL_ROOT_PASSWORD: root
          POSTGRES_PASSWORD: postgres
        ports:
          - ${{ matrix.db_port }}:${{ matrix.db_port }}
        options: >-
          --health-cmd "${{ matrix.db == 'mysql' && 'mysqladmin ping -h 127.0.0.1' || 'pg_isready' }}"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: pdo_mysql, pdo_pgsql
          coverage: none

      - name: Install dependencies
        run: composer install --no-ansi --no-interaction --no-progress --prefer-dist

      - name: Run functional tests
        env:
          TENANT_DB_DRIVER: ${{ matrix.db_driver }}
          TENANT_DB_HOST: 127.0.0.1
          TENANT_DB_PORT: ${{ matrix.db_port }}
          TENANT_DB_USER: ${{ matrix.db_user }}
          TENANT_DB_PASSWORD: ${{ matrix.db_password }}
          TENANT_DB_SERVER_VERSION: ${{ matrix.server_version }}
        run: vendor/bin/phpunit --testsuite functional --no-coverage
