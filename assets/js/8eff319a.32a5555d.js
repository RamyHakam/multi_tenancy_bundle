"use strict";(globalThis.webpackChunkmulti_tenancy_bundle_docs=globalThis.webpackChunkmulti_tenancy_bundle_docs||[]).push([[164],{3875(n,e,t){t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>s,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"customization/customization","title":"Custom TenantConfigProvider & TenantDatabaseManager","description":"Learn how to override the default Doctrine-based provider and manager with your own logic","source":"@site/docs/customization/customization.md","sourceDirName":"customization","slug":"/customization/","permalink":"/multi_tenancy_bundle/customization/","draft":false,"unlisted":false,"editUrl":"https://github.com/RamyHakam/multi_tenancy_bundle/tree/master/docs-site/docs/customization/customization.md","tags":[],"version":"current","frontMatter":{"id":"customization","title":"Custom TenantConfigProvider & TenantDatabaseManager","sidebar\\\\_label":"Customization","description":"Learn how to override the default Doctrine-based provider and manager with your own logic"},"sidebar":"tutorialSidebar","previous":{"title":"Tenant-Aware Cache Isolation","permalink":"/multi_tenancy_bundle/cache/cache-isolation"},"next":{"title":"Suggested Patterns for Use","permalink":"/multi_tenancy_bundle/suggestions/"}}');var a=t(4848),r=t(8453);const s={id:"customization",title:"Custom TenantConfigProvider & TenantDatabaseManager",sidebar_label:"Customization",description:"Learn how to override the default Doctrine-based provider and manager with your own logic"},o="Customizing Tenant Configuration & Management",c={},l=[{value:"Why Override?",id:"why-override",level:2},{value:"How It Works",id:"how-it-works",level:2},{value:"Approach 1: <code>#[AsAlias]</code> Attribute (Recommended)",id:"approach-1-asalias-attribute-recommended",level:3},{value:"Approach 2: Config-based Override (Provider Only)",id:"approach-2-config-based-override-provider-only",level:3},{value:"Example: Config from ENV or Secrets Manager",id:"example-config-from-env-or-secrets-manager",level:2},{value:"Example: Dummy Manager (No Doctrine)",id:"example-dummy-manager-no-doctrine",level:2},{value:"Use with Custom Security",id:"use-with-custom-security",level:2},{value:"Summary",id:"summary",level:2}];function d(n){const e={blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.header,{children:(0,a.jsx)(e.h1,{id:"customizing-tenant-configuration--management",children:"Customizing Tenant Configuration & Management"})}),"\n",(0,a.jsxs)(e.p,{children:["Starting with version ",(0,a.jsx)(e.code,{children:"3.0.0"}),", the Multi-Tenancy Bundle supports ",(0,a.jsx)(e.strong,{children:"plug-and-play customization"})," for the core tenant configuration and database management logic."]}),"\n",(0,a.jsx)(e.p,{children:"By default, the bundle uses Doctrine for:"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:"Storing tenant DB configurations in an entity."}),"\n",(0,a.jsx)(e.li,{children:"Managing databases (e.g., creation, status updates) via Doctrine DBAL."}),"\n"]}),"\n",(0,a.jsxs)(e.p,{children:["But this is ",(0,a.jsx)(e.strong,{children:"fully overrideable"})," with your own custom implementations."]}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"why-override",children:"Why Override?"}),"\n",(0,a.jsx)(e.p,{children:"Overriding is useful when:"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsxs)(e.li,{children:["\n",(0,a.jsxs)(e.p,{children:["You store ",(0,a.jsx)(e.strong,{children:"tenant configuration outside Doctrine"}),", for example in:"]}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:"Redis"}),"\n",(0,a.jsx)(e.li,{children:"Flat files"}),"\n",(0,a.jsx)(e.li,{children:"Environment variables"}),"\n",(0,a.jsx)(e.li,{children:"Secret management tools (e.g., Infisical, Vault, AWS Secrets Manager)"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(e.li,{children:["\n",(0,a.jsxs)(e.p,{children:["You want to implement ",(0,a.jsx)(e.strong,{children:"custom DB credential handling"}),", such as:"]}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:"Obfuscated or hashed passwords"}),"\n",(0,a.jsx)(e.li,{children:"Rotating credentials"}),"\n",(0,a.jsx)(e.li,{children:"Centralized credential storage"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(e.li,{children:["\n",(0,a.jsxs)(e.p,{children:["You need to fetch configurations from ",(0,a.jsx)(e.strong,{children:"external APIs"})," or config servers."]}),"\n"]}),"\n",(0,a.jsxs)(e.li,{children:["\n",(0,a.jsx)(e.p,{children:"You want to decouple tenant database management from Doctrine (e.g., serverless environments or multi-region DBs)."}),"\n"]}),"\n",(0,a.jsxs)(e.li,{children:["\n",(0,a.jsxs)(e.p,{children:["You want to support ",(0,a.jsx)(e.strong,{children:"dynamic tenant creation workflows"})," (e.g., provisioning on signup)."]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(e.p,{children:"This allows maximum flexibility for integrating your own infrastructure and security model while still using the bundle's powerful multi-tenancy engine."}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"how-it-works",children:"How It Works"}),"\n",(0,a.jsxs)(e.p,{children:["The bundle uses the following ",(0,a.jsx)(e.strong,{children:"interfaces"})," internally:"]}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.code,{children:"TenantConfigProviderInterface"})," \u2014 returns ",(0,a.jsx)(e.code,{children:"TenantConnectionConfigDTO"})," for a given tenant."]}),"\n",(0,a.jsxs)(e.li,{children:[(0,a.jsx)(e.code,{children:"TenantDatabaseManagerInterface"})," \u2014 responsible for creating, listing, and updating tenant DBs."]}),"\n"]}),"\n",(0,a.jsxs)(e.p,{children:["There are ",(0,a.jsx)(e.strong,{children:"two approaches"})," to override these services:"]}),"\n",(0,a.jsxs)(e.h3,{id:"approach-1-asalias-attribute-recommended",children:["Approach 1: ",(0,a.jsx)(e.code,{children:"#[AsAlias]"})," Attribute (Recommended)"]}),"\n",(0,a.jsxs)(e.p,{children:["This is the idiomatic Symfony way. Simply implement the interface and annotate your class with ",(0,a.jsx)(e.code,{children:"#[AsAlias]"}),". Symfony's autoconfigure will automatically replace the default service."]}),"\n",(0,a.jsxs)(e.p,{children:["Works for ",(0,a.jsx)(e.strong,{children:"both"})," ",(0,a.jsx)(e.code,{children:"TenantConfigProviderInterface"})," and ",(0,a.jsx)(e.code,{children:"TenantDatabaseManagerInterface"}),"."]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-php",children:"use Hakam\\MultiTenancyBundle\\Port\\TenantConfigProviderInterface;\nuse Symfony\\Component\\DependencyInjection\\Attribute\\AsAlias;\n\n#[AsAlias(TenantConfigProviderInterface::class)]\nclass MyCustomConfigProvider implements TenantConfigProviderInterface\n{\n    public function getTenantConnectionConfig(mixed $identifier): TenantConnectionConfigDTO\n    {\n        // your custom logic\n    }\n}\n"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-php",children:"use Hakam\\MultiTenancyBundle\\Port\\TenantDatabaseManagerInterface;\nuse Symfony\\Component\\DependencyInjection\\Attribute\\AsAlias;\n\n#[AsAlias(TenantDatabaseManagerInterface::class)]\nclass MyCustomDatabaseManager implements TenantDatabaseManagerInterface\n{\n    // your implementation\n}\n"})}),"\n",(0,a.jsxs)(e.blockquote,{children:["\n",(0,a.jsxs)(e.p,{children:["No need to touch ",(0,a.jsx)(e.code,{children:"services.yaml"})," \u2014 just use ",(0,a.jsx)(e.code,{children:"#[AsAlias(...)]"})," and your class will be auto-wired as a replacement."]}),"\n"]}),"\n",(0,a.jsx)(e.h3,{id:"approach-2-config-based-override-provider-only",children:"Approach 2: Config-based Override (Provider Only)"}),"\n",(0,a.jsxs)(e.p,{children:["For the ",(0,a.jsx)(e.code,{children:"TenantConfigProviderInterface"}),", you can also use the bundle configuration to point to a custom service ID:"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"# config/packages/hakam_multi_tenancy.yaml\nhakam_multi_tenancy:\n    tenant_config_provider: App\\Service\\MyCustomConfigProvider\n    # ...\n"})}),"\n",(0,a.jsxs)(e.p,{children:["When set to a value other than the default ",(0,a.jsx)(e.code,{children:"hakam_tenant_config_provider.doctrine"}),", the bundle will alias ",(0,a.jsx)(e.code,{children:"TenantConfigProviderInterface"})," to your service. The Doctrine-specific ",(0,a.jsx)(e.code,{children:"tenant_database_className"})," and ",(0,a.jsx)(e.code,{children:"tenant_database_identifier"})," settings are skipped in this case."]}),"\n",(0,a.jsxs)(e.blockquote,{children:["\n",(0,a.jsxs)(e.p,{children:[(0,a.jsx)(e.strong,{children:"Note:"})," Your service must be registered in the container (either via ",(0,a.jsx)(e.code,{children:"services.yaml"})," or autoconfigure)."]}),"\n"]}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"example-config-from-env-or-secrets-manager",children:"Example: Config from ENV or Secrets Manager"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-php",children:"use Hakam\\MultiTenancyBundle\\Config\\TenantConnectionConfigDTO;\nuse Hakam\\MultiTenancyBundle\\Port\\TenantConfigProviderInterface;\nuse Hakam\\MultiTenancyBundle\\Enum\\DriverTypeEnum;\nuse Hakam\\MultiTenancyBundle\\Enum\\DatabaseStatusEnum;\nuse Symfony\\Component\\DependencyInjection\\Attribute\\AsAlias;\n\n#[AsAlias(TenantConfigProviderInterface::class)]\nclass EnvTenantConfigProvider implements TenantConfigProviderInterface\n{\n    public function getTenantConnectionConfig(mixed $identifier): TenantConnectionConfigDTO\n    {\n        return TenantConnectionConfigDTO::fromArgs(\n            identifier: (int) ($_ENV['TENANT_ID'] ?? 1),\n            driver: DriverTypeEnum::MYSQL,\n            dbStatus: DatabaseStatusEnum::DATABASE_CREATED,\n            host: $_ENV['TENANT_DB_HOST'],\n            port: (int) ($_ENV['TENANT_DB_PORT'] ?? 3306),\n            dbname: $_ENV['TENANT_DB_NAME'],\n            user: $_ENV['TENANT_DB_USER'],\n            password: $_ENV['TENANT_DB_PASSWORD']\n        );\n    }\n}\n"})}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"example-dummy-manager-no-doctrine",children:"Example: Dummy Manager (No Doctrine)"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-php",children:"use Hakam\\MultiTenancyBundle\\Config\\TenantConnectionConfigDTO;\nuse Hakam\\MultiTenancyBundle\\Enum\\DriverTypeEnum;\nuse Hakam\\MultiTenancyBundle\\Enum\\DatabaseStatusEnum;\nuse Hakam\\MultiTenancyBundle\\Port\\TenantDatabaseManagerInterface;\nuse Symfony\\Component\\DependencyInjection\\Attribute\\AsAlias;\n\n#[AsAlias(TenantDatabaseManagerInterface::class)]\nclass DummyTenantDatabaseManager implements TenantDatabaseManagerInterface\n{\n    public function listDatabases(): array\n    {\n        return [\n            TenantConnectionConfigDTO::fromArgs(\n                identifier: 1,\n                driver: DriverTypeEnum::MYSQL,\n                dbStatus: DatabaseStatusEnum::DATABASE_MIGRATED,\n                host: 'dummy',\n                port: 3306,\n                dbname: 'tenant1',\n                user: 'user',\n                password: 'pass'\n            ),\n        ];\n    }\n\n    public function listMissingDatabases(): array\n    {\n        return [];\n    }\n\n    public function getDefaultTenantIDatabase(): TenantConnectionConfigDTO\n    {\n        return $this->listDatabases()[0];\n    }\n\n    public function createTenantDatabase(TenantConnectionConfigDTO $dto): bool\n    {\n        return true; // or call external API to provision the DB\n    }\n\n    public function getTenantDatabaseById(mixed $identifier): TenantConnectionConfigDTO\n    {\n        return $this->listDatabases()[0];\n    }\n\n    public function getTenantDbListByDatabaseStatus(DatabaseStatusEnum $status): array\n    {\n        return [];\n    }\n\n    public function addNewTenantDbConfig(TenantConnectionConfigDTO $dto): TenantConnectionConfigDTO\n    {\n        return $dto;\n    }\n\n    public function updateTenantDatabaseStatus(mixed $identifier, DatabaseStatusEnum $status): bool\n    {\n        return true;\n    }\n}\n"})}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"use-with-custom-security",children:"Use with Custom Security"}),"\n",(0,a.jsx)(e.p,{children:"By combining this with custom tenant resolvers or identity mapping, you can securely:"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:"Retrieve DB credentials from secrets"}),"\n",(0,a.jsx)(e.li,{children:"Auto-provision on signup"}),"\n",(0,a.jsx)(e.li,{children:"Rotate credentials dynamically"}),"\n",(0,a.jsx)(e.li,{children:"Disable tenants without deleting data"}),"\n"]}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"summary",children:"Summary"}),"\n",(0,a.jsx)(e.p,{children:"You can fully override the tenant data source and management layer by swapping two services."}),"\n",(0,a.jsxs)(e.table,{children:[(0,a.jsx)(e.thead,{children:(0,a.jsxs)(e.tr,{children:[(0,a.jsx)(e.th,{children:"Interface"}),(0,a.jsx)(e.th,{children:(0,a.jsx)(e.code,{children:"#[AsAlias]"})}),(0,a.jsx)(e.th,{children:"Config-based"})]})}),(0,a.jsxs)(e.tbody,{children:[(0,a.jsxs)(e.tr,{children:[(0,a.jsx)(e.td,{children:(0,a.jsx)(e.code,{children:"TenantConfigProviderInterface"})}),(0,a.jsx)(e.td,{children:"Supported"}),(0,a.jsx)(e.td,{children:(0,a.jsx)(e.code,{children:"tenant_config_provider: your.service.id"})})]}),(0,a.jsxs)(e.tr,{children:[(0,a.jsx)(e.td,{children:(0,a.jsx)(e.code,{children:"TenantDatabaseManagerInterface"})}),(0,a.jsx)(e.td,{children:"Supported"}),(0,a.jsx)(e.td,{children:"N/A"})]})]})]}),"\n",(0,a.jsxs)(e.p,{children:["This keeps the bundle ",(0,a.jsx)(e.strong,{children:"flexible"}),", ",(0,a.jsx)(e.strong,{children:"lightweight"}),", and ",(0,a.jsx)(e.strong,{children:"agnostic"})," to your infrastructure \u2014 while still offering a powerful and scalable multi-tenant foundation."]})]})}function u(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(d,{...n})}):d(n)}},8453(n,e,t){t.d(e,{R:()=>s,x:()=>o});var i=t(6540);const a={},r=i.createContext(a);function s(n){const e=i.useContext(r);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:s(n.components),i.createElement(r.Provider,{value:e},n.children)}}}]);