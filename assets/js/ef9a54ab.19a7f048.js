"use strict";(globalThis.webpackChunkmulti_tenancy_bundle_docs=globalThis.webpackChunkmulti_tenancy_bundle_docs||[]).push([[474],{8677(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"usage/usage","title":"Usage & Features","description":"The Usage & Features section dives into the core capabilities of the Symfony Multi-Tenancy Bundle. You\'ll find detailed workflows, examples, and best practices for each major feature:","source":"@site/docs/usage/usage.md","sourceDirName":"usage","slug":"/usage/","permalink":"/multi_tenancy_bundle/usage/","draft":false,"unlisted":false,"editUrl":"https://github.com/RamyHakam/multi_tenancy_bundle/tree/master/docs-site/docs/usage/usage.md","tags":[],"version":"current","frontMatter":{"title":"Usage & Features"},"sidebar":"tutorialSidebar","previous":{"title":"Core Concepts","permalink":"/multi_tenancy_bundle/concepts/core-concepts"},"next":{"title":"Tenant Lifecycle Events","permalink":"/multi_tenancy_bundle/events/lifecycle-events"}}');var s=t(4848),a=t(8453);const r={title:"Usage & Features"},c=void 0,l={},o=[{value:"Runtime DB Switching",id:"runtime-db-switching",level:2},{value:"Tenant Migrations",id:"tenant-migrations",level:2},{value:"Bulk Operations",id:"bulk-operations",level:2},{value:"Tenant Fixtures",id:"tenant-fixtures",level:2},{value:"Custom Drivers &amp; Credentials",id:"custom-drivers--credentials",level:2},{value:"Cache Isolation",id:"cache-isolation",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.strong,{children:"Usage & Features"})," section dives into the core capabilities of the Symfony Multi-Tenancy Bundle. You'll find detailed workflows, examples, and best practices for each major feature:"]}),"\n",(0,s.jsx)(n.h2,{id:"runtime-db-switching",children:"Runtime DB Switching"}),"\n",(0,s.jsx)(n.p,{children:"Dynamically switch the active database connection to a tenant\u2019s database at runtime."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use Hakam\\MultiTenancyBundle\\Event\\SwitchDbEvent;\nuse Hakam\\MultiTenancyBundle\\Doctrine\\ORM\\TenantEntityManager;\nuse Symfony\\Contracts\\EventDispatcher\\EventDispatcherInterface;\n\nclass OrderController\n{\n    public function __construct(\n        private TenantEntityManager $tenantEm,\n        private EventDispatcherInterface $dispatcher\n    ) {}\n\n    public function createOrder(int $tenantId)\n    {\n        // Switch to tenant DB\n        $this->dispatcher->dispatch(new SwitchDbEvent($tenantId));\n\n        // Use tenant EM as usual\n        $order = new Order();\n        $order->setTotal(49.99);\n        $this->tenantEm->persist($order);\n        $this->tenantEm->flush();\n    }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Advanced Tips"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Dispatch using either the tenant ID or the full ",(0,s.jsx)(n.code,{children:"TenantDbConfig"})," entity."]}),"\n",(0,s.jsx)(n.li,{children:"Minimize dispatch calls by batching operations per tenant."}),"\n",(0,s.jsxs)(n.li,{children:["Enable ",(0,s.jsx)(n.code,{children:"auto_create"})," in config to let the bundle provision tenant DBs on demand."]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"tenant-migrations",children:"Tenant Migrations"}),"\n",(0,s.jsx)(n.p,{children:"Manage each tenant\u2019s schema migrations independently from your main application."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Generate a new migration for tenant entities\nphp bin/console tenant:migration:diff --dbid=3\n\n# Initialize a newly created tenant database\nphp bin/console tenant:migration:migrate init --dbid=3\n\n# Update all existing tenant DBs to latest\nphp bin/console tenant:migration:migrate update --all\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key Options"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--dbid"}),": target a specific tenant by ID."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"init"})," vs ",(0,s.jsx)(n.code,{children:"update"}),": run initial migrations on new DBs vs apply diffs to existing."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"--all"}),": run the command across every tenant DB in one go."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Best Practices"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Preview diffs (",(0,s.jsx)(n.code,{children:"--dry-run"}),") before running in production."]}),"\n",(0,s.jsxs)(n.li,{children:["Keep tenant migration files under ",(0,s.jsx)(n.code,{children:"migrations/Tenant"})," to avoid conflicts."]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"bulk-operations",children:"Bulk Operations"}),"\n",(0,s.jsx)(n.p,{children:"Perform cross-tenant tasks programmatically, such as data migrations or analytics."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"$tenants = $mainEm->getRepository(TenantDbConfig::class)->findAll();\nforeach ($tenants as $config) {\n    // Switch once per tenant\n    $dispatcher->dispatch(new SwitchDbEvent($config));\n\n    // Example: seed a default setting\n    $setting = new TenantSetting();\n    $setting->setKey('timezone')->setValue('UTC');\n    $tenantEm->persist($setting);\n    $tenantEm->flush();\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Optimizations"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Use generators or ",(0,s.jsx)(n.code,{children:"yield"})," to stream large tenant lists."]}),"\n",(0,s.jsx)(n.li,{children:"Wrap each tenant loop in a database transaction to rollback on failure."}),"\n",(0,s.jsx)(n.li,{children:"Parallelize using Symfony Messenger or CLI batching for large fleets."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"tenant-fixtures",children:"Tenant Fixtures"}),"\n",(0,s.jsx)(n.p,{children:"Seed tenant-specific demo or test data via the same Doctrine fixtures API."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use Hakam\\MultiTenancyBundle\\Attribute\\TenantFixture;\nuse Doctrine\\Bundle\\FixturesBundle\\Fixture;\nuse Doctrine\\Persistence\\ObjectManager;\n\n#[TenantFixture]\nclass ProductFixtures extends Fixture\n{\n    public function load(ObjectManager $manager)\n    {\n        $product = new Product();\n        $product->setName('Demo Product');\n        $manager->persist($product);\n    }\n}\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Load only tenant fixtures, per-tenant or all\nphp bin/console tenant:fixtures:load --dbid=5 --append\nphp bin/console tenant:fixtures:load --all\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Fixture Groups & Dependencies"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Use ",(0,s.jsx)(n.code,{children:"--group="})," to segment fixtures by purpose (e.g. ",(0,s.jsx)(n.code,{children:"demo"}),", ",(0,s.jsx)(n.code,{children:"test"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:["Leverage Doctrine\u2019s ",(0,s.jsx)(n.code,{children:"DependentFixtureInterface"})," to define load order."]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"custom-drivers--credentials",children:"Custom Drivers & Credentials"}),"\n",(0,s.jsx)(n.p,{children:"Override default DBAL settings per tenant for advanced sharding or hosted setups."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# global default\nhakam_multi_tenancy:\n  tenant_connection:\n    driver: 'pdo_mysql'\n    host: '%env(TENANT_DB_HOST)%'\n\n# override in TenantDbConfig entity:\nclass TenantDbConfig implements TenantDbConfigurationInterface\n{\n    public function getDriver(): string\n    {\n        return 'pdo_pgsql';\n    }\n\n    public function getHost(): string\n    {\n        return $this->customHost;\n    }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Use Cases"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Point high-tier tenants at dedicated clusters (e.g., AWS RDS vs on-prem)."}),"\n",(0,s.jsx)(n.li,{children:"Mix MySQL main database with PostgreSQL tenant stores for specific analytics."}),"\n",(0,s.jsx)(n.li,{children:"Rotate credentials programmatically for security compliance."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"cache-isolation",children:"Cache Isolation"}),"\n",(0,s.jsx)(n.p,{children:"Prevent cross-tenant cache collisions when sharing a backend like Redis or Memcached."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# config/packages/hakam_multi_tenancy.yaml\nhakam_multi_tenancy:\n    cache:\n        enabled: true\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Once enabled, all ",(0,s.jsx)(n.code,{children:"cache.app"})," operations are automatically scoped to the active tenant. No code changes needed:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-php",children:"use Symfony\\Contracts\\Cache\\CacheInterface;\nuse Symfony\\Contracts\\Cache\\ItemInterface;\n\nclass ReportService\n{\n    public function __construct(\n        private CacheInterface $cache,\n        private TenantEntityManager $tenantEm\n    ) {}\n\n    public function getMonthlyStats(): array\n    {\n        // Key is automatically prefixed with the tenant ID\n        return $this->cache->get('monthly_stats', function (ItemInterface $item) {\n            $item->expiresAfter(3600);\n\n            return $this->tenantEm->getRepository(Order::class)\n                ->getMonthlyStats();\n        });\n    }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"How It Works"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["The bundle decorates ",(0,s.jsx)(n.code,{children:"cache.app"})," with ",(0,s.jsx)(n.code,{children:"TenantAwareCacheDecorator"})]}),"\n",(0,s.jsxs)(n.li,{children:["Keys are prefixed: ",(0,s.jsx)(n.code,{children:"{tenantId}__key"})," (e.g., ",(0,s.jsx)(n.code,{children:"acme__monthly_stats"}),")"]}),"\n",(0,s.jsx)(n.li,{children:"When no tenant is active, keys pass through unprefixed"}),"\n",(0,s.jsxs)(n.li,{children:["The ",(0,s.jsx)(n.code,{children:"TenantContext"})," service tracks the current tenant and resets between requests"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key Points"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Enable with ",(0,s.jsx)(n.code,{children:"cache.enabled: true"})," \u2014 disabled by default, fully backward-compatible."]}),"\n",(0,s.jsxs)(n.li,{children:["Works with PSR-6 (",(0,s.jsx)(n.code,{children:"CacheItemPoolInterface"}),") and Symfony Contracts (",(0,s.jsx)(n.code,{children:"CacheInterface"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:["Pairs naturally with ",(0,s.jsx)(n.a,{href:"/resolver/automatic-resolution",children:"Automatic Tenant Resolution"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"/cache/cache-isolation",children:"Full Cache Isolation documentation \u2192"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.p,{children:"With these usage patterns and examples, you'll harness the full power of the Symfony Multi-Tenancy Bundle to build robust, scalable, and secure multi-tenant applications."})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453(e,n,t){t.d(n,{R:()=>r,x:()=>c});var i=t(6540);const s={},a=i.createContext(s);function r(e){const n=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);