"use strict";(globalThis.webpackChunkmulti_tenancy_bundle_docs=globalThis.webpackChunkmulti_tenancy_bundle_docs||[]).push([[290],{640(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"resolver/automatic-resolution","title":"Automatic Tenant Resolution","description":"Available since v3.0.0","source":"@site/docs/resolver/automatic-resolution.md","sourceDirName":"resolver","slug":"/resolver/automatic-resolution","permalink":"/multi_tenancy_bundle/resolver/automatic-resolution","draft":false,"unlisted":false,"editUrl":"https://github.com/RamyHakam/multi_tenancy_bundle/tree/master/docs-site/docs/resolver/automatic-resolution.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"title":"Automatic Tenant Resolution","sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"Tenant CLI Commands Reference","permalink":"/multi_tenancy_bundle/cli/cli-commands"},"next":{"title":"Tenant-Aware Cache Isolation","permalink":"/multi_tenancy_bundle/cache/cache-isolation"}}');var i=t(4848),r=t(8453);const a={title:"Automatic Tenant Resolution",sidebar_position:1},o="Automatic Tenant Resolution",l={},c=[{value:"Why Use Automatic Resolution?",id:"why-use-automatic-resolution",level:2},{value:"Quick Start",id:"quick-start",level:2},{value:"Resolution Strategies",id:"resolution-strategies",level:2},{value:"Subdomain Strategy",id:"subdomain-strategy",level:3},{value:"Header Strategy",id:"header-strategy",level:3},{value:"Path Strategy",id:"path-strategy",level:3},{value:"Host Strategy",id:"host-strategy",level:3},{value:"Chain Strategy",id:"chain-strategy",level:3},{value:"Configuration Reference",id:"configuration-reference",level:2},{value:"Full Configuration Example",id:"full-configuration-example",level:3},{value:"Configuration Options",id:"configuration-options",level:3},{value:"Accessing the Resolved Tenant",id:"accessing-the-resolved-tenant",level:2},{value:"Request Attributes",id:"request-attributes",level:3},{value:"Custom Resolvers",id:"custom-resolvers",level:2},{value:"Register Your Custom Resolver",id:"register-your-custom-resolver",level:3},{value:"Using Custom Resolver with Chain Strategy",id:"using-custom-resolver-with-chain-strategy",level:3},{value:"Error Handling",id:"error-handling",level:2},{value:"Graceful Degradation (Default)",id:"graceful-degradation-default",level:3},{value:"Strict Mode",id:"strict-mode",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"1. Exclude Public Routes",id:"1-exclude-public-routes",level:3},{value:"2. Use Header Strategy for APIs",id:"2-use-header-strategy-for-apis",level:3},{value:"3. Combine with Security",id:"3-combine-with-security",level:3},{value:"4. Cache Host Mappings",id:"4-cache-host-mappings",level:3},{value:"Backward Compatibility",id:"backward-compatibility",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Tenant Not Being Resolved",id:"tenant-not-being-resolved",level:3},{value:"Wrong Tenant Resolved",id:"wrong-tenant-resolved",level:3},{value:"Resolution Happening Too Late",id:"resolution-happening-too-late",level:3}];function d(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"automatic-tenant-resolution",children:"Automatic Tenant Resolution"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Available since v3.0.0"})}),"\n",(0,i.jsxs)(n.p,{children:["The Automatic Tenant Resolution feature eliminates the need to manually dispatch ",(0,i.jsx)(n.code,{children:"SwitchDbEvent"})," in your controllers. The bundle automatically determines the current tenant from incoming HTTP requests and switches the database context before your controller executes."]}),"\n",(0,i.jsx)(n.h2,{id:"why-use-automatic-resolution",children:"Why Use Automatic Resolution?"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Before (Manual)"}),(0,i.jsx)(n.th,{children:"After (Automatic)"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:["Dispatch ",(0,i.jsx)(n.code,{children:"SwitchDbEvent"})," in every controller"]}),(0,i.jsx)(n.td,{children:"Configure once, works everywhere"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Boilerplate code in each tenant-aware action"}),(0,i.jsx)(n.td,{children:"Zero boilerplate"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Easy to forget switching in some routes"}),(0,i.jsx)(n.td,{children:"Consistent tenant context"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"quick-start",children:"Quick Start"}),"\n",(0,i.jsx)(n.p,{children:"Enable automatic resolution in your configuration:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# config/packages/hakam_multi_tenancy.yaml\nhakam_multi_tenancy:\n    resolver:\n        enabled: true\n        strategy: subdomain\n        options:\n            base_domain: 'myapp.com'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["That's it! Requests to ",(0,i.jsx)(n.code,{children:"tenant1.myapp.com"})," will automatically switch to the ",(0,i.jsx)(n.code,{children:"tenant1"})," database."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"resolution-strategies",children:"Resolution Strategies"}),"\n",(0,i.jsx)(n.p,{children:"The bundle provides five built-in strategies for extracting tenant identifiers from requests."}),"\n",(0,i.jsx)(n.h3,{id:"subdomain-strategy",children:"Subdomain Strategy"}),"\n",(0,i.jsx)(n.p,{children:"Extracts the tenant identifier from the subdomain portion of the hostname."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Example:"})," ",(0,i.jsx)(n.code,{children:"acme.myapp.com"})," \u2192 tenant ID: ",(0,i.jsx)(n.code,{children:"acme"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"hakam_multi_tenancy:\n    resolver:\n        enabled: true\n        strategy: subdomain\n        options:\n            base_domain: 'myapp.com'      # Required: your base domain\n            subdomain_position: 0          # Optional: which subdomain part (default: 0)\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Use cases:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"SaaS applications with custom subdomains per customer"}),"\n",(0,i.jsxs)(n.li,{children:["Regional deployments (",(0,i.jsx)(n.code,{children:"us.app.com"}),", ",(0,i.jsx)(n.code,{children:"eu.app.com"}),")"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Multi-level subdomains:"})}),"\n",(0,i.jsxs)(n.p,{children:["For ",(0,i.jsx)(n.code,{children:"api.acme.myapp.com"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"subdomain_position: 0"})," \u2192 ",(0,i.jsx)(n.code,{children:"api"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"subdomain_position: 1"})," \u2192 ",(0,i.jsx)(n.code,{children:"acme"})]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"header-strategy",children:"Header Strategy"}),"\n",(0,i.jsx)(n.p,{children:"Extracts the tenant identifier from an HTTP header. Ideal for API-first applications."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Example:"})," ",(0,i.jsx)(n.code,{children:"X-Tenant-ID: acme"})," \u2192 tenant ID: ",(0,i.jsx)(n.code,{children:"acme"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"hakam_multi_tenancy:\n    resolver:\n        enabled: true\n        strategy: header\n        options:\n            header_name: 'X-Tenant-ID'    # Optional: default is 'X-Tenant-ID'\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Use cases:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"REST/GraphQL APIs where clients specify their tenant"}),"\n",(0,i.jsx)(n.li,{children:"Mobile applications with tenant selection"}),"\n",(0,i.jsx)(n.li,{children:"Microservices communicating tenant context"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"path-strategy",children:"Path Strategy"}),"\n",(0,i.jsx)(n.p,{children:"Extracts the tenant identifier from a URL path segment."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Example:"})," ",(0,i.jsx)(n.code,{children:"/acme/dashboard"})," \u2192 tenant ID: ",(0,i.jsx)(n.code,{children:"acme"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"hakam_multi_tenancy:\n    resolver:\n        enabled: true\n        strategy: path\n        options:\n            path_segment: 0               # Optional: which segment (default: 0)\n        excluded_paths:                   # Optional: paths to skip\n            - '/api/public'\n            - '/health'\n            - '/_profiler'\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Use cases:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Applications where tenants are part of the URL structure"}),"\n",(0,i.jsx)(n.li,{children:"Legacy systems migrating to multi-tenancy"}),"\n",(0,i.jsx)(n.li,{children:"Shared hosting environments"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"host-strategy",children:"Host Strategy"}),"\n",(0,i.jsx)(n.p,{children:"Maps complete hostnames to tenant identifiers. Useful when tenants have their own custom domains."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Example:"})," ",(0,i.jsx)(n.code,{children:"acme-corp.com"})," \u2192 tenant ID: ",(0,i.jsx)(n.code,{children:"acme"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"hakam_multi_tenancy:\n    resolver:\n        enabled: true\n        strategy: host\n        options:\n            host_map:\n                'acme-corp.com': 'acme'\n                'beta-inc.com': 'beta'\n                'gamma.example.com': 'gamma'\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Use cases:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"White-label applications with custom domains"}),"\n",(0,i.jsx)(n.li,{children:"Enterprise customers with vanity URLs"}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{title:"Dynamic Host Mapping",type:"tip",children:(0,i.jsx)(n.p,{children:"For dynamic host mapping, implement a custom resolver that queries your database."})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"chain-strategy",children:"Chain Strategy"}),"\n",(0,i.jsx)(n.p,{children:"Combines multiple strategies with fallback support. Tries each resolver in order until one succeeds."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"hakam_multi_tenancy:\n    resolver:\n        enabled: true\n        strategy: chain\n        options:\n            chain_order:\n                - header      # Try header first (for API clients)\n                - subdomain   # Then subdomain (for web users)\n                - path        # Finally path (fallback)\n            # Include options for each sub-strategy\n            header_name: 'X-Tenant-ID'\n            base_domain: 'myapp.com'\n            path_segment: 0\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Use cases:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Applications serving both API and web clients"}),"\n",(0,i.jsx)(n.li,{children:"Gradual migration from one strategy to another"}),"\n",(0,i.jsx)(n.li,{children:"Supporting multiple tenant identification methods"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"configuration-reference",children:"Configuration Reference"}),"\n",(0,i.jsx)(n.h3,{id:"full-configuration-example",children:"Full Configuration Example"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"hakam_multi_tenancy:\n    # ... other configuration ...\n    \n    resolver:\n        # Enable/disable automatic resolution (default: false)\n        enabled: true\n        \n        # Resolution strategy: subdomain | header | path | host | chain\n        strategy: subdomain\n        \n        # Throw exception if tenant cannot be resolved (default: false)\n        throw_on_missing: false\n        \n        # Paths to exclude from resolution\n        excluded_paths:\n            - '/health'\n            - '/metrics'\n            - '/_profiler'\n            - '/api/public'\n        \n        # Strategy-specific options\n        options:\n            # Subdomain options\n            subdomain_position: 0\n            base_domain: 'myapp.com'\n            \n            # Header options\n            header_name: 'X-Tenant-ID'\n            \n            # Path options\n            path_segment: 0\n            \n            # Host options\n            host_map:\n                'custom-domain.com': 'tenant1'\n            \n            # Chain options\n            chain_order:\n                - header\n                - subdomain\n                - path\n"})}),"\n",(0,i.jsx)(n.h3,{id:"configuration-options",children:"Configuration Options"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Option"}),(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Default"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"enabled"})}),(0,i.jsx)(n.td,{children:"bool"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"false"})}),(0,i.jsx)(n.td,{children:"Enable automatic resolution"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"strategy"})}),(0,i.jsx)(n.td,{children:"string"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"subdomain"})}),(0,i.jsx)(n.td,{children:"Resolution strategy to use"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"throw_on_missing"})}),(0,i.jsx)(n.td,{children:"bool"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"false"})}),(0,i.jsx)(n.td,{children:"Throw exception if tenant not found"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"excluded_paths"})}),(0,i.jsx)(n.td,{children:"array"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"[]"})}),(0,i.jsx)(n.td,{children:"Paths to skip resolution"})]})]})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"accessing-the-resolved-tenant",children:"Accessing the Resolved Tenant"}),"\n",(0,i.jsx)(n.p,{children:"Once resolved, the tenant identifier is available in the request attributes:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"// In a controller\npublic function dashboard(Request $request): Response\n{\n    $tenantId = $request->attributes->get('_tenant');\n    \n    if ($tenantId === null) {\n        // No tenant resolved (public route?)\n    }\n    \n    // The database is already switched - just use TenantEntityManager\n    $orders = $this->tenantEm->getRepository(Order::class)->findAll();\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"request-attributes",children:"Request Attributes"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Attribute"}),(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"_tenant"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"string|null"})}),(0,i.jsx)(n.td,{children:"The resolved tenant identifier"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"_tenant_resolved"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"bool"})}),(0,i.jsx)(n.td,{children:"Whether resolution was attempted"})]})]})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"custom-resolvers",children:"Custom Resolvers"}),"\n",(0,i.jsxs)(n.p,{children:["Implement ",(0,i.jsx)(n.code,{children:"TenantResolverInterface"})," for custom resolution logic:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Resolver;\n\nuse Hakam\\MultiTenancyBundle\\Port\\TenantResolverInterface;\nuse Symfony\\Component\\HttpFoundation\\Request;\n\nclass CookieResolver implements TenantResolverInterface\n{\n    public function resolve(Request $request): ?string\n    {\n        return $request->cookies->get('tenant_id');\n    }\n\n    public function supports(Request $request): bool\n    {\n        return $request->cookies->has('tenant_id');\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"register-your-custom-resolver",children:"Register Your Custom Resolver"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# config/services.yaml\nservices:\n    App\\Resolver\\CookieResolver:\n        tags: ['hakam.tenant_resolver']\n"})}),"\n",(0,i.jsx)(n.h3,{id:"using-custom-resolver-with-chain-strategy",children:"Using Custom Resolver with Chain Strategy"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"<?php\n\nnamespace App\\Resolver;\n\nuse Hakam\\MultiTenancyBundle\\Port\\TenantResolverInterface;\nuse Doctrine\\ORM\\EntityManagerInterface;\nuse Symfony\\Component\\HttpFoundation\\Request;\n\nclass DatabaseHostResolver implements TenantResolverInterface\n{\n    public function __construct(\n        private EntityManagerInterface $em\n    ) {}\n\n    public function resolve(Request $request): ?string\n    {\n        $host = $request->getHost();\n        \n        // Query your database for host-to-tenant mapping\n        $mapping = $this->em->getRepository(DomainMapping::class)\n            ->findOneBy(['domain' => $host]);\n        \n        return $mapping?->getTenantId();\n    }\n\n    public function supports(Request $request): bool\n    {\n        return true; // Always try to resolve\n    }\n}\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsx)(n.h3,{id:"graceful-degradation-default",children:"Graceful Degradation (Default)"}),"\n",(0,i.jsx)(n.p,{children:"By default, if no tenant can be resolved, the request continues without switching databases:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"resolver:\n    enabled: true\n    throw_on_missing: false  # Default\n"})}),"\n",(0,i.jsx)(n.p,{children:"This is useful for applications with public routes."}),"\n",(0,i.jsx)(n.h3,{id:"strict-mode",children:"Strict Mode"}),"\n",(0,i.jsxs)(n.p,{children:["Enable ",(0,i.jsx)(n.code,{children:"throw_on_missing"})," to throw an exception when resolution fails:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"resolver:\n    enabled: true\n    throw_on_missing: true\n"})}),"\n",(0,i.jsx)(n.p,{children:"Handle the exception in your error handler:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"// src/EventListener/TenantExceptionListener.php\nuse Symfony\\Component\\HttpKernel\\Event\\ExceptionEvent;\n\nclass TenantExceptionListener\n{\n    public function onKernelException(ExceptionEvent $event): void\n    {\n        $exception = $event->getThrowable();\n        \n        if (str_contains($exception->getMessage(), 'Unable to resolve tenant')) {\n            $event->setResponse(new Response('Tenant not found', 404));\n        }\n    }\n}\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsx)(n.h3,{id:"1-exclude-public-routes",children:"1. Exclude Public Routes"}),"\n",(0,i.jsx)(n.p,{children:"Always exclude routes that don't require tenant context:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"resolver:\n    excluded_paths:\n        - '/health'\n        - '/login'\n        - '/api/public'\n        - '/_profiler'\n        - '/_wdt'\n"})}),"\n",(0,i.jsx)(n.h3,{id:"2-use-header-strategy-for-apis",children:"2. Use Header Strategy for APIs"}),"\n",(0,i.jsx)(n.p,{children:"For API-first applications, the header strategy provides the most flexibility:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"resolver:\n    strategy: header\n    options:\n        header_name: 'X-Tenant-ID'\n"})}),"\n",(0,i.jsx)(n.h3,{id:"3-combine-with-security",children:"3. Combine with Security"}),"\n",(0,i.jsx)(n.p,{children:"Validate that the authenticated user has access to the resolved tenant:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"public function onKernelController(ControllerEvent $event): void\n{\n    $request = $event->getRequest();\n    $tenantId = $request->attributes->get('_tenant');\n    $user = $this->security->getUser();\n    \n    if ($tenantId && $user && !$user->hasAccessTo($tenantId)) {\n        throw new AccessDeniedException('No access to this tenant');\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"4-cache-host-mappings",children:"4. Cache Host Mappings"}),"\n",(0,i.jsx)(n.p,{children:"For the host strategy with many mappings, consider caching:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"class CachedHostResolver implements TenantResolverInterface\n{\n    public function __construct(\n        private CacheInterface $cache,\n        private EntityManagerInterface $em\n    ) {}\n\n    public function resolve(Request $request): ?string\n    {\n        $host = $request->getHost();\n        \n        return $this->cache->get('tenant_host_' . $host, function () use ($host) {\n            $mapping = $this->em->getRepository(DomainMapping::class)\n                ->findOneBy(['domain' => $host]);\n            return $mapping?->getTenantId();\n        });\n    }\n}\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"backward-compatibility",children:"Backward Compatibility"}),"\n",(0,i.jsxs)(n.p,{children:["Automatic resolution is ",(0,i.jsx)(n.strong,{children:"disabled by default"}),". Your existing code using manual ",(0,i.jsx)(n.code,{children:"SwitchDbEvent"})," dispatching continues to work:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"// This still works, even with resolver enabled\n$this->dispatcher->dispatch(new SwitchDbEvent($tenantId));\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You can also override automatic resolution by dispatching ",(0,i.jsx)(n.code,{children:"SwitchDbEvent"})," manually after the automatic resolution has occurred."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsx)(n.h3,{id:"tenant-not-being-resolved",children:"Tenant Not Being Resolved"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Check configuration:"})," Ensure ",(0,i.jsx)(n.code,{children:"resolver.enabled: true"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Verify strategy options:"})," For subdomain, ensure ",(0,i.jsx)(n.code,{children:"base_domain"})," matches your host"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Check excluded paths:"})," Make sure your route isn't excluded"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Debug:"})," Check request attributes for ",(0,i.jsx)(n.code,{children:"_tenant_resolved"})]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"wrong-tenant-resolved",children:"Wrong Tenant Resolved"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Check subdomain_position:"})," For multi-level subdomains, verify the position"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Verify path_segment:"})," Ensure you're extracting the correct segment"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Debug:"})," Log the resolved tenant in a listener"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"resolution-happening-too-late",children:"Resolution Happening Too Late"}),"\n",(0,i.jsxs)(n.p,{children:["The listener runs with priority ",(0,i.jsx)(n.code,{children:"32"})," (after router, before controller). If you need earlier resolution, create a custom listener with higher priority."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453(e,n,t){t.d(n,{R:()=>a,x:()=>o});var s=t(6540);const i={},r=s.createContext(i);function a(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);