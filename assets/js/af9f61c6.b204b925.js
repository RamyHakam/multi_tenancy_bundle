"use strict";(globalThis.webpackChunkmulti_tenancy_bundle_docs=globalThis.webpackChunkmulti_tenancy_bundle_docs||[]).push([[491],{6099(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>c,metadata:()=>a,toc:()=>o});const a=JSON.parse('{"id":"cache/cache-isolation","title":"Tenant-Aware Cache Isolation","description":"Available since v3.0.0","source":"@site/docs/cache/cache-isolation.md","sourceDirName":"cache","slug":"/cache/cache-isolation","permalink":"/multi_tenancy_bundle/cache/cache-isolation","draft":false,"unlisted":false,"editUrl":"https://github.com/RamyHakam/multi_tenancy_bundle/tree/master/docs-site/docs/cache/cache-isolation.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"title":"Tenant-Aware Cache Isolation","sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"Automatic Tenant Resolution","permalink":"/multi_tenancy_bundle/resolver/automatic-resolution"},"next":{"title":"Custom TenantConfigProvider & TenantDatabaseManager","permalink":"/multi_tenancy_bundle/customization/"}}');var i=t(4848),s=t(8453);const c={title:"Tenant-Aware Cache Isolation",sidebar_position:1},r="Tenant-Aware Cache Isolation",l={},o=[{value:"Why Cache Isolation Matters",id:"why-cache-isolation-matters",level:2},{value:"Quick Start",id:"quick-start",level:2},{value:"How It Works",id:"how-it-works",level:2},{value:"Usage Examples",id:"usage-examples",level:2},{value:"Basic Cache Operations",id:"basic-cache-operations",level:3},{value:"Using Symfony Cache Contracts",id:"using-symfony-cache-contracts",level:3},{value:"Combining with Runtime DB Switching",id:"combining-with-runtime-db-switching",level:3},{value:"TenantContext",id:"tenantcontext",level:2},{value:"Reading the Current Tenant",id:"reading-the-current-tenant",level:3},{value:"How TenantContext Gets Updated",id:"how-tenantcontext-gets-updated",level:3},{value:"Configuration Reference",id:"configuration-reference",level:2},{value:"Full Configuration",id:"full-configuration",level:3},{value:"Configuration Options",id:"configuration-options",level:3},{value:"Custom Separator",id:"custom-separator",level:3},{value:"Testing",id:"testing",level:2},{value:"Using TenantTestTrait",id:"using-tenanttesttrait",level:3},{value:"Manual TenantContext Testing",id:"manual-tenantcontext-testing",level:3},{value:"Architecture Details",id:"architecture-details",level:2},{value:"Services Registered",id:"services-registered",level:3},{value:"Interfaces Implemented by the Decorator",id:"interfaces-implemented-by-the-decorator",level:3},{value:"Key Prefixing Behavior",id:"key-prefixing-behavior",level:3},{value:"Known Limitations",id:"known-limitations",level:2},{value:"<code>clear()</code> Clears All Tenants",id:"clear-clears-all-tenants",level:3},{value:"Only Decorates <code>cache.app</code>",id:"only-decorates-cacheapp",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"1. Enable Cache Isolation in Production",id:"1-enable-cache-isolation-in-production",level:3},{value:"2. Use Meaningful Tenant Identifiers",id:"2-use-meaningful-tenant-identifiers",level:3},{value:"3. Invalidate Per-Tenant, Not Globally",id:"3-invalidate-per-tenant-not-globally",level:3},{value:"4. Combine with Automatic Resolution",id:"4-combine-with-automatic-resolution",level:3},{value:"Backward Compatibility",id:"backward-compatibility",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"tenant-aware-cache-isolation",children:"Tenant-Aware Cache Isolation"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Available since v3.0.0"})}),"\n",(0,i.jsx)(n.p,{children:"The Tenant-Aware Cache Isolation feature prevents cross-tenant data leakage through shared cache backends. When multiple tenants share the same Redis, Memcached, or filesystem cache, identical cache keys can collide and expose one tenant's data to another. This feature transparently prefixes all cache keys with the active tenant's identifier, ensuring complete isolation."}),"\n",(0,i.jsx)(n.h2,{id:"why-cache-isolation-matters",children:"Why Cache Isolation Matters"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Without Cache Isolation"}),(0,i.jsx)(n.th,{children:"With Cache Isolation"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:["Tenant A writes ",(0,i.jsx)(n.code,{children:"user_count = 50"})]}),(0,i.jsxs)(n.td,{children:["Tenant A writes ",(0,i.jsx)(n.code,{children:"tenantA__user_count = 50"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:["Tenant B reads ",(0,i.jsx)(n.code,{children:"user_count"})," and gets ",(0,i.jsx)(n.code,{children:"50"})]}),(0,i.jsxs)(n.td,{children:["Tenant B reads ",(0,i.jsx)(n.code,{children:"tenantB__user_count"})," and gets its own value"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Cross-tenant data leakage"}),(0,i.jsx)(n.td,{children:"Complete isolation, zero leakage"})]})]})]}),"\n",(0,i.jsx)(n.admonition,{title:"Security Risk",type:"danger",children:(0,i.jsx)(n.p,{children:"Without cache isolation, any cache key shared between tenants can leak sensitive data \u2014 user counts, settings, computed results, or even serialized entities. This is especially critical when using Redis or Memcached as a shared cache backend."})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"quick-start",children:"Quick Start"}),"\n",(0,i.jsx)(n.p,{children:"Enable cache isolation in your configuration:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"# config/packages/hakam_multi_tenancy.yaml\nhakam_multi_tenancy:\n    cache:\n        enabled: true\n"})}),"\n",(0,i.jsxs)(n.p,{children:["That's it! All operations on ",(0,i.jsx)(n.code,{children:"cache.app"})," are now automatically scoped to the active tenant."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"how-it-works",children:"How It Works"}),"\n",(0,i.jsxs)(n.p,{children:["The bundle decorates Symfony's ",(0,i.jsx)(n.code,{children:"cache.app"})," service with a ",(0,i.jsx)(n.code,{children:"TenantAwareCacheDecorator"})," that:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Reads the active tenant"})," from ",(0,i.jsx)(n.code,{children:"TenantContext"})," (updated automatically on every ",(0,i.jsx)(n.code,{children:"TenantSwitchedEvent"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Prefixes cache keys"})," with ",(0,i.jsx)(n.code,{children:"{tenantId}__{key}"})," before delegating to the inner cache pool"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Strips the prefix"})," from returned ",(0,i.jsx)(n.code,{children:"CacheItem"})," keys so your application code sees the original key"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Passes through unprefixed"})," when no tenant is active (e.g., during CLI commands or public routes)"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Tenant A active:  cache->getItem('settings')  \u2192  inner->getItem('tenantA__settings')\nTenant B active:  cache->getItem('settings')  \u2192  inner->getItem('tenantB__settings')\nNo tenant:        cache->getItem('settings')  \u2192  inner->getItem('settings')\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"usage-examples",children:"Usage Examples"}),"\n",(0,i.jsx)(n.h3,{id:"basic-cache-operations",children:"Basic Cache Operations"}),"\n",(0,i.jsxs)(n.p,{children:["No code changes needed \u2014 inject ",(0,i.jsx)(n.code,{children:"CacheItemPoolInterface"})," or ",(0,i.jsx)(n.code,{children:"CacheInterface"})," as usual:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"use Psr\\Cache\\CacheItemPoolInterface;\n\nclass DashboardService\n{\n    public function __construct(\n        private CacheItemPoolInterface $cache\n    ) {}\n\n    public function getStats(): array\n    {\n        $item = $this->cache->getItem('dashboard_stats');\n\n        if (!$item->isHit()) {\n            $stats = $this->computeExpensiveStats();\n            $item->set($stats);\n            $item->expiresAfter(3600);\n            $this->cache->save($item);\n        }\n\n        return $item->get();\n    }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["When Tenant A is active, ",(0,i.jsx)(n.code,{children:"dashboard_stats"})," is stored as ",(0,i.jsx)(n.code,{children:"tenantA__dashboard_stats"}),". When Tenant B is active, it gets its own isolated copy. Your service code never changes."]}),"\n",(0,i.jsx)(n.h3,{id:"using-symfony-cache-contracts",children:"Using Symfony Cache Contracts"}),"\n",(0,i.jsxs)(n.p,{children:["The decorator also implements ",(0,i.jsx)(n.code,{children:"Symfony\\Contracts\\Cache\\CacheInterface"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"use Symfony\\Contracts\\Cache\\CacheInterface;\nuse Symfony\\Contracts\\Cache\\ItemInterface;\n\nclass ProductCatalogService\n{\n    public function __construct(\n        private CacheInterface $cache\n    ) {}\n\n    public function getFeaturedProducts(): array\n    {\n        return $this->cache->get('featured_products', function (ItemInterface $item) {\n            $item->expiresAfter(1800);\n\n            return $this->repository->findFeatured();\n        });\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"combining-with-runtime-db-switching",children:"Combining with Runtime DB Switching"}),"\n",(0,i.jsx)(n.p,{children:"Cache isolation works seamlessly with manual tenant switching:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"use Hakam\\MultiTenancyBundle\\Event\\SwitchDbEvent;\n\nclass TenantReportService\n{\n    public function __construct(\n        private EventDispatcherInterface $dispatcher,\n        private CacheInterface $cache,\n        private TenantEntityManager $tenantEm\n    ) {}\n\n    public function generateReport(int $tenantId): array\n    {\n        // Switch to tenant \u2014 cache is now automatically scoped\n        $this->dispatcher->dispatch(new SwitchDbEvent($tenantId));\n\n        return $this->cache->get('monthly_report', function () {\n            return $this->tenantEm->getRepository(Order::class)\n                ->getMonthlyReport();\n        });\n    }\n}\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"tenantcontext",children:"TenantContext"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"TenantContext"})," service is the canonical source of the current tenant identity. It is always registered (even when cache isolation is disabled) and can be used in your own services."]}),"\n",(0,i.jsx)(n.h3,{id:"reading-the-current-tenant",children:"Reading the Current Tenant"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"use Hakam\\MultiTenancyBundle\\Context\\TenantContextInterface;\n\nclass AuditLogger\n{\n    public function __construct(\n        private TenantContextInterface $tenantContext\n    ) {}\n\n    public function log(string $message): void\n    {\n        $tenantId = $this->tenantContext->getTenantId();\n        // $tenantId is null when no tenant is active\n\n        $this->logger->info($message, ['tenant' => $tenantId]);\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"how-tenantcontext-gets-updated",children:"How TenantContext Gets Updated"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"TenantContext"})," listens to ",(0,i.jsx)(n.code,{children:"TenantSwitchedEvent"})," (fired by ",(0,i.jsx)(n.code,{children:"DbSwitchEventListener"})," after a successful connection switch). It stores the tenant identifier as a string. It also implements ",(0,i.jsx)(n.code,{children:"ResetInterface"}),", so it resets to ",(0,i.jsx)(n.code,{children:"null"})," between requests in long-running processes."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"configuration-reference",children:"Configuration Reference"}),"\n",(0,i.jsx)(n.h3,{id:"full-configuration",children:"Full Configuration"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"hakam_multi_tenancy:\n    # ... other configuration ...\n\n    cache:\n        # Enable/disable tenant-aware cache isolation (default: false)\n        enabled: true\n\n        # Separator between tenant ID and cache key (default: '__')\n        prefix_separator: '__'\n"})}),"\n",(0,i.jsx)(n.h3,{id:"configuration-options",children:"Configuration Options"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Option"}),(0,i.jsx)(n.th,{children:"Type"}),(0,i.jsx)(n.th,{children:"Default"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"enabled"})}),(0,i.jsx)(n.td,{children:"bool"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"false"})}),(0,i.jsx)(n.td,{children:"Enable tenant-aware cache key prefixing"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"prefix_separator"})}),(0,i.jsx)(n.td,{children:"string"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"__"})}),(0,i.jsx)(n.td,{children:"Separator between tenant ID and original key"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"custom-separator",children:"Custom Separator"}),"\n",(0,i.jsx)(n.p,{children:"If your tenant IDs contain double underscores, use a different separator:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"hakam_multi_tenancy:\n    cache:\n        enabled: true\n        prefix_separator: '||'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This changes the key format from ",(0,i.jsx)(n.code,{children:"tenantA__key"})," to ",(0,i.jsx)(n.code,{children:"tenantA||key"}),"."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,i.jsx)(n.h3,{id:"using-tenanttesttrait",children:"Using TenantTestTrait"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"TenantTestTrait"})," automatically resets ",(0,i.jsx)(n.code,{children:"TenantContext"})," in ",(0,i.jsx)(n.code,{children:"resetTenantState()"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"use Hakam\\MultiTenancyBundle\\Test\\TenantTestTrait;\n\nclass CachedServiceTest extends KernelTestCase\n{\n    use TenantTestTrait;\n\n    public function testCacheIsolation(): void\n    {\n        $cache = self::getContainer()->get('cache.app');\n\n        // Write as tenant A\n        $this->switchToTenant('tenant_a');\n        $item = $cache->getItem('key');\n        $item->set('value_a');\n        $cache->save($item);\n\n        // Write as tenant B\n        $this->switchToTenant('tenant_b');\n        $item = $cache->getItem('key');\n        $this->assertFalse($item->isHit()); // Isolated!\n        $item->set('value_b');\n        $cache->save($item);\n\n        // Verify tenant A still sees its own data\n        $this->switchToTenant('tenant_a');\n        $item = $cache->getItem('key');\n        $this->assertSame('value_a', $item->get());\n    }\n\n    protected function tearDown(): void\n    {\n        $this->resetTenantState();\n        parent::tearDown();\n    }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"manual-tenantcontext-testing",children:"Manual TenantContext Testing"}),"\n",(0,i.jsx)(n.p,{children:"For unit tests where you don't need the full kernel, inject a mock:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"use Hakam\\MultiTenancyBundle\\Context\\TenantContextInterface;\n\nclass MyServiceTest extends TestCase\n{\n    public function testWithTenant(): void\n    {\n        $context = $this->createMock(TenantContextInterface::class);\n        $context->method('getTenantId')->willReturn('tenant_42');\n\n        $service = new MyService($context);\n        // ...\n    }\n}\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"architecture-details",children:"Architecture Details"}),"\n",(0,i.jsx)(n.h3,{id:"services-registered",children:"Services Registered"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Service"}),(0,i.jsx)(n.th,{children:"Condition"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"TenantContext"})}),(0,i.jsx)(n.td,{children:"Always"}),(0,i.jsx)(n.td,{children:"Tracks current tenant identity"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"TenantContextInterface"})}),(0,i.jsx)(n.td,{children:"Always"}),(0,i.jsxs)(n.td,{children:["Alias to ",(0,i.jsx)(n.code,{children:"TenantContext"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"TenantAwareCacheDecorator"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"cache.enabled: true"})}),(0,i.jsxs)(n.td,{children:["Decorates ",(0,i.jsx)(n.code,{children:"cache.app"})]})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"interfaces-implemented-by-the-decorator",children:"Interfaces Implemented by the Decorator"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Psr\\Cache\\CacheItemPoolInterface"})," (PSR-6)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Symfony\\Contracts\\Cache\\CacheInterface"})," (Symfony Contracts)"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"key-prefixing-behavior",children:"Key Prefixing Behavior"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Scenario"}),(0,i.jsx)(n.th,{children:"Input Key"}),(0,i.jsx)(n.th,{children:"Stored Key"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:["Tenant ",(0,i.jsx)(n.code,{children:"acme"})," active"]}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"settings"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"acme__settings"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:["Tenant ",(0,i.jsx)(n.code,{children:"42"})," active"]}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"user_count"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"42__user_count"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"No tenant active"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"global_config"})}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"global_config"})})]})]})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"known-limitations",children:"Known Limitations"}),"\n",(0,i.jsxs)(n.h3,{id:"clear-clears-all-tenants",children:[(0,i.jsx)(n.code,{children:"clear()"})," Clears All Tenants"]}),"\n",(0,i.jsxs)(n.p,{children:["Calling ",(0,i.jsx)(n.code,{children:"$cache->clear()"})," delegates to the inner pool and clears ",(0,i.jsx)(n.strong,{children:"all"})," cached data, including other tenants. This is a limitation of PSR-6's ",(0,i.jsx)(n.code,{children:"clear()"})," which takes no arguments for scoping."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Workaround:"})," Use ",(0,i.jsx)(n.code,{children:"deleteItem()"})," or ",(0,i.jsx)(n.code,{children:"deleteItems()"})," for tenant-scoped cache invalidation instead of ",(0,i.jsx)(n.code,{children:"clear()"}),"."]}),"\n",(0,i.jsxs)(n.h3,{id:"only-decorates-cacheapp",children:["Only Decorates ",(0,i.jsx)(n.code,{children:"cache.app"})]}),"\n",(0,i.jsxs)(n.p,{children:["The decorator is applied to ",(0,i.jsx)(n.code,{children:"cache.app"})," (Symfony's default application cache pool). If you use custom cache pools, they are not automatically decorated."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Workaround:"})," Manually decorate additional pools in your service configuration:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"services:\n    app.tenant_aware_custom_cache:\n        class: Hakam\\MultiTenancyBundle\\Cache\\TenantAwareCacheDecorator\n        decorates: 'cache.custom_pool'\n        arguments:\n            - '@.inner'\n            - '@Hakam\\MultiTenancyBundle\\Context\\TenantContextInterface'\n            - '__'\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsx)(n.h3,{id:"1-enable-cache-isolation-in-production",children:"1. Enable Cache Isolation in Production"}),"\n",(0,i.jsx)(n.p,{children:"If tenants share a cache backend (Redis, Memcached), always enable cache isolation:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"hakam_multi_tenancy:\n    cache:\n        enabled: true\n"})}),"\n",(0,i.jsx)(n.h3,{id:"2-use-meaningful-tenant-identifiers",children:"2. Use Meaningful Tenant Identifiers"}),"\n",(0,i.jsx)(n.p,{children:"Since tenant IDs become part of cache keys, prefer short, filesystem-safe identifiers:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Good:  acme, tenant_42, org-7\nAvoid: My Company Name!, tenant/with/slashes\n"})}),"\n",(0,i.jsx)(n.h3,{id:"3-invalidate-per-tenant-not-globally",children:"3. Invalidate Per-Tenant, Not Globally"}),"\n",(0,i.jsxs)(n.p,{children:["Avoid ",(0,i.jsx)(n.code,{children:"$cache->clear()"})," in multi-tenant contexts. Instead, track and delete specific keys:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"// Instead of $cache->clear()\n$cache->deleteItems(['dashboard_stats', 'user_count', 'settings']);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"4-combine-with-automatic-resolution",children:"4. Combine with Automatic Resolution"}),"\n",(0,i.jsxs)(n.p,{children:["Cache isolation pairs naturally with ",(0,i.jsx)(n.a,{href:"/resolver/automatic-resolution",children:"Automatic Tenant Resolution"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"hakam_multi_tenancy:\n    resolver:\n        enabled: true\n        strategy: subdomain\n        options:\n            base_domain: 'myapp.com'\n    cache:\n        enabled: true\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Requests to ",(0,i.jsx)(n.code,{children:"acme.myapp.com"})," automatically switch the database ",(0,i.jsx)(n.strong,{children:"and"})," scope the cache."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"backward-compatibility",children:"Backward Compatibility"}),"\n",(0,i.jsxs)(n.p,{children:["Cache isolation is ",(0,i.jsx)(n.strong,{children:"disabled by default"}),". Enabling it requires no changes to your existing application code \u2014 the decorator transparently wraps ",(0,i.jsx)(n.code,{children:"cache.app"})," and prefixes keys only when a tenant is active."]}),"\n",(0,i.jsx)(n.p,{children:"Your existing cache usage continues to work exactly as before:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-php",children:"// This works identically with or without cache isolation\n$item = $cache->getItem('my_key');\n"})})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453(e,n,t){t.d(n,{R:()=>c,x:()=>r});var a=t(6540);const i={},s=a.createContext(i);function c(e){const n=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);